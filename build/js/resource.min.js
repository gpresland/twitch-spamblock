// TWITCH SpamBlock
//
// Copyright (c) Year(s), gpresland@gmail.com
// Permission to use, copy, modify, and/or distribute this software for any purpose with
// or without fee is hereby granted, provided that the above copyright notice and this
// permission notice appear in all copies.
//
// THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD
// TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN
// NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
// DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER
// IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
// CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
!function(a,b){function c(a){return a=f.apply(a),"undefined"!=typeof a&&"undefined"!=typeof a.tsb?(g.incrementMessages(),a.tsb.block===!0?void g.incrementBlocked():a):void 0}function d(){var a=require("web-client/views/chat")["default"],b=a.prototype.didInsertElement;a.prototype.didInsertElement=function(){b.apply(this,arguments),e(c),g.initialize()}}function e(a){var b=require("web-client/models/room")["default"],c=b.prototype.addMessage,d=b.prototype.send;b.prototype.addMessage=function(b){return b="function"==typeof a&&a(b),c.apply(this,arguments)},b.prototype.send=function(a){return d.apply(this,arguments)}}b["true"]=a;var f={DONGER_COMMONS:[172,186,662,664,860,865,3232,3234,3900,3901,5463,5465,5586,5589,7508,8226,8226,8636,8640,8736,8745,8779,8860,9472,9495,9499,9548,9552,9568,9581,9582,9583,9586,9632,9632,9633,9648,9673,9685,9730,9737,9788,9829,10023,10047,10061,11386,11807,12539,12541,12559,20033,20984,30410,42826,65439,65507],SAFE_WORDS:["loss","lost","no","win","won","yes"],FILTER_ORDER:["command","long","short","allcaps","drawing","donger","cyrillic","custom","copypaste","emotes","lowercase","cleanup"],filters:{allcaps:function(a){var b,c,d,e;b=a.tsb.text.match(/[a-z]/g),d=a.tsb.text.match(/[A-Z]/g),c=null!==b?b.length:0,e=null!==d?d.length:0,e>c&&(a.tsb.block=!0)},cleanup:function(a){a.message=a.message.trim().replace(/\s{2,}/g," ")},command:function(a){a.tsb.isCommand===!0&&(a.tsb.block=!0)},copypaste:function(a){f.history.isRepeat(a.tsb.text)?a.tsb.block=!0:f.history.add(a.tsb.text)},custom:function(a){var b;for(b=0;b<tsb.settings.blockstring.length;b++)if(-1!==a.tsb.text.toLowerCase().indexOf(tsb.settings.blockstring[b])){a.tsb.block=!0;break}},cyrillic:function(a){/[\u0400-\u052F]/.test(a.tsb.text)&&(a.tsb.block=!0)},debug:function(a,b){console.log("TSB {"+b+"} blocked: "+a.message)},donger:function(a){var b,c;for(c=0;c<a.tsb.text.length;c++)if(b=a.tsb.text.charCodeAt(c),-1!==f.DONGER_COMMONS.indexOf(b)){a.tsb.block=!0;break}},drawing:function(a){var b,c;for(c=0;c<a.tsb.text.length;c++)if(b=a.tsb.text.charCodeAt(c),b>=9600&&9649>=b){a.tsb.block=!0;break}},emotes:function(a){a.message=a.tsb.text,a.hasOwnProperty("tags")&&"undefined"!=typeof a.tags&&a.tags.hasOwnProperty("emotes")&&(a.tags.emotes={})},"long":function(a){a.tsb.text.length>=192&&(a.tsb.block=!0)},lowercase:function(a){a.message=a.message.toLowerCase()},"short":function(a){var b,c,d,e=[];if(a.tsb.text.replace(/s+/g,"").length<5&&(d=a.tsb.text.toLowerCase().replace(/\W/g,""),-1===f.SAFE_WORDS.indexOf(d)))return void(a.tsb.block=!0);for(c=0;c<a.tsb.text.length;c++)b=a.tsb.text.charCodeAt(c),-1===e.indexOf(b)&&e.push(b);return e.length<5?void(a.tsb.block=!0):void 0}},history:{log:[],add:function(a){this.log.unshift(a),this.log.length>=100&&this.log.pop()},isRepeat:function(a){return-1!==this.log.indexOf(a)?!0:!1}},getEmotelessText:function(a){if(a.hasOwnProperty("tags")&&"undefined"!=typeof a.tags&&a.tags.hasOwnProperty("emotes")&&"undefined"!=typeof a.tags.emotes&&Object.keys(a.tags.emotes).length>0){var b,c,d,e,f,g,h,i;c=[],h=a.message;for(f in a.tags.emotes)b=a.tags.emotes[f],i=b[0][0],d=b[0][1],g=d-i+1,c.push(a.message.substr(i,g));for(e=0;e<c.length;e++)c[e]=c[e].replace("\\","\\\\").replace("(","\\(").replace(")","\\)"),h=h.replace(new RegExp(c[e],"g"),"");return h}return a.message},getEmoteCount:function(a){if(a.hasOwnProperty("tags")&&"undefined"!=typeof a.tags&&a.tags.hasOwnProperty("emotes")&&"undefined"!=typeof a.tags.emotes){var b,c,d;b=0,d=Object.keys(a.tags.emotes).length;for(c in a.tags.emotes)b+=a.tags.emotes[c].length;return b}return 0},getIsCommand:function(a){return a.tsb.text.length>2?/^![0-9A-Za-z]/.test(a.tsb.text.trim()):!1},getWordCount:function(a){var b=a.tsb.text.match(/\S+/g);return b?b.length:0},initMessage:function(a){a.tsb={block:!1,blockReason:null,emoteCount:0,isCommand:null,text:"",wordCount:0},a.tsb.text=this.getEmotelessText(a),a.tsb.emoteCount=this.getEmoteCount(a),a.tsb.isCommand=this.getIsCommand(a),a.tsb.wordCount=this.getWordCount(a)},apply:function(a){if("undefined"!=typeof a){var b,c,d,e;for(b=tsb.settings.options.debug,this.initMessage(a),c=0;c<this.FILTER_ORDER.length;c++)if(d=this.FILTER_ORDER[c],e=tsb.settings.options[d],e.value===!0&&this.filters[e.name](a),a.tsb.block&&b.value===!0){this.filters.debug(a,e.name);break}return a}}},g={blockCount:0,messageCount:0,initialize:function(){this.blockCount=0,this.messageCount=0,$(".chat-buttons-container").append('<a class="button glyph-only float-left" title="Viewer List">Blocked <span id="tsb-block-count">0</span> of <span id="tsb-message-count">0</span></a>')},incrementBlocked:function(){$("#tsb-block-count").text(g.blockCount++)},incrementMessages:function(){var a=$("#tsb-message-count");a.hasOwnProperty("0")===!1&&g.initialize(),a.text(g.messageCount++)}};!function(){"use strict";var a="0.0";$(".chat-lines").length?(e(c),g.initialize()):d(),console.log("Twitch SpamBlock extension version "+a+" loaded")}()}({},function(){return this}());